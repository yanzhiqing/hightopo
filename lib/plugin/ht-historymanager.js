!function(t,B,p){"use strict";var b="ht",n=t[b],$=n.Default,m=$.def,e=$.getInternal();n.HistoryManager=function(H){this._histories=[],this.setDataModel(H)},m(n.HistoryManager,B,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var V=this;V._betweenTransaction++,1===V._betweenTransaction&&(V._transactionHistories={})}},endTransaction:function(){if(0!==this._betweenTransaction){var w=this,R=w._histories;if(w._betweenTransaction>0&&w._betweenTransaction--,0===w._betweenTransaction){if(w._transactionHistories){var q=[];for(var X in w._transactionHistories)q.push(w._transactionHistories[X]);q.length&&(R=R.slice(0,w._historyIndex+1),R.push(q),R.length>w._maxHistoryCount&&(R=R.slice(R.length-w._maxHistoryCount)),w.setHistories(R),w.setHistoryIndex(R.length-1,!0))}delete w._transactionHistories}}},setDataModel:function(S){var n=this,f=n._dataModel;f!==S&&(f&&(delete f._historyManager,f.ump(n.handleDataModelPropertyChange,n),f.umm(n.$5p,n),f.umd(n.$6p,n),f.removeHierarchyChangeListener(n.handleHierarchyChange,n),f.removeIndexChangeListener(n.handleIndexChange,n)),n._dataModel=S,S&&(S._historyManager=n,S.mp(n.handleDataModelPropertyChange,n),S.mm(n.$5p,n),S.md(n.$6p,n),S.addHierarchyChangeListener(n.handleHierarchyChange,n),S.addIndexChangeListener(n.handleIndexChange,n)),n.fp("dataModel",f,S),n.clear())},setHistoryIndex:function(Y,x){var i=this,b=i._historyIndex,A=i._histories.length;if(-1>Y?Y=-1:Y>=A&&(Y=A-1),b!==Y){if(!x){var t=Y-b;t>0?i.$2p(t):0>t&&i.$1p(-t)}i._historyIndex=Y,i.fp("historyIndex",b,Y),i.dataModel&&i.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(M){var v=this,h=v._histories,V=v._maxHistoryCount;(!M||0>=M)&&(M=10),V!==M&&(v._maxHistoryCount=M,v.fp("maxHistoryCount",V,M),h.length>M&&v.clear())},cloneValue:function(u){return n.Default.clone(u)},isPropertyUndoable:function(a){return a&&!this.ignoredPropertyMap[a]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(H){return H&&!this.ignoreDataModelPropertyMap[H]},$5p:function(N){this.handleChange(N,N.kind)},$6p:function(q){this.handleChange(q,"property")},handleHierarchyChange:function(l){this.handleChange(l,"hierarchy")},handleIndexChange:function(s){this.handleChange(s,"index")},handleDataModelPropertyChange:function(T){this.handleChange(T,"dataModelProperty")},toChildrenInfo:function(z){var a={};return a.data=z,a.children=[],z.eachChild(function(Y){a.children.push(this.toChildrenInfo(Y))},this),a},restoreChildren:function(x){var A=x.data;x.children.forEach(function(g){var p=g.data;p.getParent()!==A&&A.addChild(p),this._dataModel.contains(p)||this._dataModel.add(p),this.restoreChildren(g)},this)},handleChange:function(t,C){var M=this;if(!(M._disabled||M._isUndoRedoing||$.loadingRefGraph)){var I,P=(M._histories,t.data),X=t.property;if(!P||!(P._refGraph||P instanceof n.RefGraph)){if("property"===C)M.isPropertyUndoable(X,P)&&(I={kind:C,data:P,property:X,oldValue:M.cloneValue(t.oldValue,P,X),newValue:M.cloneValue(t.newValue,P,X),event:t});else if("hierarchy"===C||"index"===C&&M.isIndexUndoable(t))I={kind:C,data:P,oldIndex:t.oldIndex,newIndex:t.newIndex,event:t};else if("clear"===C)I={kind:C,json:t.json,event:t};else if("add"===C){if(I={kind:C,data:P,event:t,childrenInfo:this.toChildrenInfo(P),parent:P.getParent()},I.parent){var N=M._dataModel.getSiblings(P);I.siblingsIndex=N.indexOf(P)}P instanceof n.Node&&(I.host=P.getHost(),I.attaches=P.getAttaches()?P.getAttaches().toArray():p),P instanceof n.Edge&&(I.source=P.getSource(),I.target=P.getTarget())}else"remove"===C?I={kind:C,data:P,event:t}:"dataModelProperty"===C&&M.isDataModelPropertyUndoable(X,P)&&(I={kind:C,property:X,oldValue:M.cloneValue(t.oldValue,P,X),newValue:M.cloneValue(t.newValue,P,X),event:t});M.addHistory(I)}}},addHistory:function(z){var Q=this;if(z)if(Q._betweenTransaction){var O=(z.data?z.data._id:0)+"_"+z.kind+"_"+z.property;if("property"===z.kind||"dataModelProperty"===z.kind){var m=Q._transactionHistories[O];m&&(z.oldValue=m.oldValue)}Q._transactionHistories[O]=z}else{var f=Q._histories;f=f.slice(0,Q._historyIndex+1),f.push([z]),f.length>Q._maxHistoryCount&&(f=f.slice(f.length-Q._maxHistoryCount)),Q.setHistories(f),Q.setHistoryIndex(f.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(v){(!v||0>=v)&&(v=1),this.setHistoryIndex(this._historyIndex-v)},$1p:function(F){if(this.canUndo()){var t,B=this,T=B._dataModel,S=B._histories,I=B._historyIndex,b=0;for(B._isUndoRedoing=!0,$.setIsolating(!0);F>0;){if(I>=0&&I<S.length){b++,t=S[I],I--;for(var g=t.length-1;g>=0;g--){var o=t[g],U=o.kind,c=o.data,A=o.property,V=o.event,f=this.cloneValue(o.oldValue,c,A);if(o.undo)o.undo();else if("add"===U)T.remove(c,{keepChildren:!0});else if("remove"===U)T.contains(c)||T.add(c,V.rootsIndex,V.datasIndex);else if("clear"===U)T.deserialize($.clone(o.json));else if("property"===U)if("parent"===A)f?f.addChild(c,V.oldIndex):(c.setParent(f),V.oldIndex>=0&&T.moveTo(c,V.oldIndex));else{var W=null;0===A.indexOf("a:")?(W="attr",A=A.replace("a:","")):0===A.indexOf("s:")?(W="style",A=A.replace("s:","")):0===A.indexOf("f:")&&(W="field",A=A.replace("f:","")),e.setPropertyValue(c,W,A,f)}else if("dataModelProperty"===U){var W=null;0===A.indexOf("a:")?(W="attr",A=A.replace("a:","")):0===A.indexOf("s:")?(W="style",A=A.replace("s:","")):0===A.indexOf("f:")&&(W="field",A=A.replace("f:","")),e.setPropertyValue(T,W,A,f)}else"hierarchy"===U?T.moveTo(c,o.oldIndex):"index"===U?T.moveToIndex(c,o.oldIndex):"selection"===U&&T.sm().ss(o.oldValue)}}F--}$.setIsolating(!1),delete B._isUndoRedoing,B.afterUndo(b)}},afterUndo:function(){},redo:function(U){(!U||0>=U)&&(U=1),this.setHistoryIndex(this._historyIndex+U)},$2p:function(U){if(this.canRedo()){var o,N=this,E=N._dataModel,i=N._histories,O=N._historyIndex,q=0;for(N._isUndoRedoing=!0,$.setIsolating(!0);U>0;){if(O>=-1&&O<i.length-1){q++,O++,o=i[O];for(var c=0;c<o.length;c++){var J=o[c],W=J.kind,w=J.data,b=J.property,V=J.event,x=this.cloneValue(J.newValue,w,b);if(J.redo)J.redo();else if("add"===W)J.parent&&!w.getParent()&&J.parent.addChild(w,J.siblingsIndex),E.contains(w)||E.add(w,V.rootsIndex,V.datasIndex),this.restoreChildren(J.childrenInfo),w instanceof n.Node&&(w.setHost(J.host),J.attaches&&J.attaches.forEach(function(q){q.setHost(w)})),w instanceof n.Edge&&(w.setSource(J.source),w.setTarget(J.target));else if("remove"===W)E.remove(w);else if("clear"===W)E.clear();else if("property"===W)if("parent"===b)x?x.addChild(w,V.newIndex):(w.setParent(x),V.newIndex>=0&&E.moveTo(w,V.newIndex));else{var B=null;0===b.indexOf("a:")?(B="attr",b=b.replace("a:","")):0===b.indexOf("s:")?(B="style",b=b.replace("s:","")):0===b.indexOf("f:")&&(B="field",b=b.replace("f:","")),e.setPropertyValue(w,B,b,x)}else if("dataModelProperty"===W){var B=null;0===b.indexOf("a:")?(B="attr",b=b.replace("a:","")):0===b.indexOf("s:")?(B="style",b=b.replace("s:","")):0===b.indexOf("f:")&&(B="field",b=b.replace("f:","")),e.setPropertyValue(E,B,b,x)}else"hierarchy"===W?E.moveTo(w,J.newIndex):"index"===W?E.moveToIndex(w,J.newIndex):"selection"===W&&E.sm().ss(J.newValue)}}U--}$.setIsolating(!1),delete N._isUndoRedoing,this.afterRedo(q)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);