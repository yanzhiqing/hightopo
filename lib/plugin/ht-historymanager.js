!function(I,H,U){"use strict";var A="ht",h=I[A],E=h.Default,T=E.def,J=E.getInternal();h.HistoryManager=function(u){this._histories=[],this.setDataModel(u)},T(h.HistoryManager,H,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var W=this;W._betweenTransaction++,1===W._betweenTransaction&&(W._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var D=this,L=D._histories;if(D._betweenTransaction>0&&D._betweenTransaction--,0===D._betweenTransaction){if(D._transactionHistories){var q=[];for(var W in D._transactionHistories)q.push(D._transactionHistories[W]);q.length&&(L=L.slice(0,D._historyIndex+1),L.push(q),L.length>D._maxHistoryCount&&(L=L.slice(L.length-D._maxHistoryCount)),D.setHistories(L),D.setHistoryIndex(L.length-1,!0))}delete D._transactionHistories}}},setDataModel:function(E){var s=this,G=s._dataModel;G!==E&&(G&&(delete G._historyManager,G.ump(s.handleDataModelPropertyChange,s),G.umm(s.$5p,s),G.umd(s.$6p,s),G.removeHierarchyChangeListener(s.handleHierarchyChange,s),G.removeIndexChangeListener(s.handleIndexChange,s)),s._dataModel=E,E&&(E._historyManager=s,E.mp(s.handleDataModelPropertyChange,s),E.mm(s.$5p,s),E.md(s.$6p,s),E.addHierarchyChangeListener(s.handleHierarchyChange,s),E.addIndexChangeListener(s.handleIndexChange,s)),s.fp("dataModel",G,E),s.clear())},setHistoryIndex:function(U,T){var Y=this,n=Y._historyIndex,B=Y._histories.length;if(-1>U?U=-1:U>=B&&(U=B-1),n!==U){if(!T){var q=U-n;q>0?Y.$2p(q):0>q&&Y.$1p(-q)}Y._historyIndex=U,Y.fp("historyIndex",n,U),Y.dataModel&&Y.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(z){var E=this,y=E._histories,Z=E._maxHistoryCount;(!z||0>=z)&&(z=10),Z!==z&&(E._maxHistoryCount=z,E.fp("maxHistoryCount",Z,z),y.length>z&&E.clear())},cloneValue:function(U){return h.Default.clone(U)},isPropertyUndoable:function(f){return f&&!this.ignoredPropertyMap[f]},isDataModelPropertyUndoable:function(P){return P&&!this.ignoreDataModelPropertyMap[P]},$5p:function(D){this.handleChange(D,D.kind)},$6p:function(x){this.handleChange(x,"property")},handleHierarchyChange:function(j){this.handleChange(j,"hierarchy")},handleIndexChange:function(k){this.handleChange(k,"index")},handleDataModelPropertyChange:function(p){this.handleChange(p,"dataModelProperty")},toChildrenInfo:function(t){var I={};return I.data=t,I.children=[],t.eachChild(function(m){I.children.push(this.toChildrenInfo(m))},this),I},restoreChildren:function(N){var k=N.data;N.children.forEach(function(q){var K=q.data;K.getParent()!==k&&k.addChild(K),this._dataModel.contains(K)||this._dataModel.add(K),this.restoreChildren(q)},this)},handleChange:function(g,F){var o=this;if(!(o._disabled||o._isUndoRedoing||E.loadingRefGraph)){var Q,K=(o._histories,g.data),w=g.property;if(!K||!(K._refGraph||K instanceof h.RefGraph)){if("property"===F)o.isPropertyUndoable(w,K)&&(Q={kind:F,data:K,property:w,oldValue:o.cloneValue(g.oldValue,K,w),newValue:o.cloneValue(g.newValue,K,w),event:g});else if("hierarchy"===F||"index"===F)Q={kind:F,data:K,oldIndex:g.oldIndex,newIndex:g.newIndex,event:g};else if("clear"===F)Q={kind:F,json:g.json,event:g};else if("add"===F){if(Q={kind:F,data:K,event:g,childrenInfo:this.toChildrenInfo(K),parent:K.getParent()},Q.parent){var C=o._dataModel.getSiblings(K);Q.siblingsIndex=C.indexOf(K)}K instanceof h.Node&&(Q.host=K.getHost(),Q.attaches=K.getAttaches()?K.getAttaches().toArray():U),K instanceof h.Edge&&(Q.source=K.getSource(),Q.target=K.getTarget())}else"remove"===F?Q={kind:F,data:K,event:g}:"dataModelProperty"===F&&o.isDataModelPropertyUndoable(w,K)&&(Q={kind:F,property:w,oldValue:o.cloneValue(g.oldValue,K,w),newValue:o.cloneValue(g.newValue,K,w),event:g});o.addHistory(Q)}}},addHistory:function(E){var R=this;if(E)if(R._betweenTransaction){var v=(E.data?E.data._id:0)+"_"+E.kind+"_"+E.property;if("property"===E.kind||"dataModelProperty"===E.kind){var I=R._transactionHistories[v];I&&(E.oldValue=I.oldValue)}R._transactionHistories[v]=E}else{var C=R._histories;C=C.slice(0,R._historyIndex+1),C.push([E]),C.length>R._maxHistoryCount&&(C=C.slice(C.length-R._maxHistoryCount)),R.setHistories(C),R.setHistoryIndex(C.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(o){(!o||0>=o)&&(o=1),this.setHistoryIndex(this._historyIndex-o)},$1p:function(b){if(this.canUndo()){var g,T=this,n=T._dataModel,R=T._histories,v=T._historyIndex,u=0;for(T._isUndoRedoing=!0,E.setIsolating(!0);b>0;){if(v>=0&&v<R.length){u++,g=R[v],v--;for(var D=g.length-1;D>=0;D--){var M=g[D],A=M.kind,S=M.data,k=M.property,K=M.event,W=this.cloneValue(M.oldValue,S,k);if(M.undo)M.undo();else if("add"===A)n.remove(S,{keepChildren:!0});else if("remove"===A)n.contains(S)||n.add(S,K.rootsIndex,K.datasIndex);else if("clear"===A)n.deserialize(E.clone(M.json));else if("property"===A)if("parent"===k)W?W.addChild(S,K.oldIndex):(S.setParent(W),K.oldIndex>=0&&n.moveTo(S,K.oldIndex));else{var U=null;0===k.indexOf("a:")?(U="attr",k=k.replace("a:","")):0===k.indexOf("s:")?(U="style",k=k.replace("s:","")):0===k.indexOf("f:")&&(U="field",k=k.replace("f:","")),J.setPropertyValue(S,U,k,W)}else if("dataModelProperty"===A){var U=null;0===k.indexOf("a:")?(U="attr",k=k.replace("a:","")):0===k.indexOf("s:")?(U="style",k=k.replace("s:","")):0===k.indexOf("f:")&&(U="field",k=k.replace("f:","")),J.setPropertyValue(n,U,k,W)}else"hierarchy"===A?n.moveTo(S,M.oldIndex):"index"===A&&n.moveToIndex(S,M.oldIndex)}}b--}E.setIsolating(!1),delete T._isUndoRedoing,T.afterUndo(u)}},afterUndo:function(){},redo:function(t){(!t||0>=t)&&(t=1),this.setHistoryIndex(this._historyIndex+t)},$2p:function(t){if(this.canRedo()){var W,m=this,K=m._dataModel,C=m._histories,o=m._historyIndex,Y=0;for(m._isUndoRedoing=!0,E.setIsolating(!0);t>0;){if(o>=-1&&o<C.length-1){Y++,o++,W=C[o];for(var F=0;F<W.length;F++){var _=W[F],n=_.kind,y=_.data,u=_.property,M=_.event,V=this.cloneValue(_.newValue,y,u);if(_.redo)_.redo();else if("add"===n)_.parent&&!y.getParent()&&_.parent.addChild(y,_.siblingsIndex),K.contains(y)||K.add(y,M.rootsIndex,M.datasIndex),this.restoreChildren(_.childrenInfo),y instanceof h.Node&&(y.setHost(_.host),_.attaches&&_.attaches.forEach(function(K){K.setHost(y)})),y instanceof h.Edge&&(y.setSource(_.source),y.setTarget(_.target));else if("remove"===n)K.remove(y);else if("clear"===n)K.clear();else if("property"===n)if("parent"===u)V?V.addChild(y,M.newIndex):(y.setParent(V),M.newIndex>=0&&K.moveTo(y,M.newIndex));else{var q=null;0===u.indexOf("a:")?(q="attr",u=u.replace("a:","")):0===u.indexOf("s:")?(q="style",u=u.replace("s:","")):0===u.indexOf("f:")&&(q="field",u=u.replace("f:","")),J.setPropertyValue(y,q,u,V)}else if("dataModelProperty"===n){var q=null;0===u.indexOf("a:")?(q="attr",u=u.replace("a:","")):0===u.indexOf("s:")?(q="style",u=u.replace("s:","")):0===u.indexOf("f:")&&(q="field",u=u.replace("f:","")),J.setPropertyValue(K,q,u,V)}else"hierarchy"===n?K.moveTo(y,_.newIndex):"index"===n&&K.moveToIndex(y,_.newIndex)}}t--}E.setIsolating(!1),delete m._isUndoRedoing,this.afterRedo(Y)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);